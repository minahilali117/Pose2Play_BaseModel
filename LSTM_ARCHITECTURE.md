# ðŸ“Š LSTM System Architecture Diagram

## Overall System Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER INTERFACE                               â”‚
â”‚                      (Browser - index.html)                          â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  MediaPipe Pose  â”‚                  â”‚  Exercise UI        â”‚    â”‚
â”‚  â”‚  - Webcam feed   â”‚                  â”‚  - Rep counter      â”‚    â”‚
â”‚  â”‚  - 33 landmarks  â”‚                  â”‚  - Angle display    â”‚    â”‚
â”‚  â”‚  - 30 FPS        â”‚                  â”‚  - Feedback text    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚           â”‚                                       â”‚                 â”‚
â”‚           â–¼                                       â”‚                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚                 â”‚
â”‚  â”‚       Angle Calculation (angles.js)          â”‚â”‚                 â”‚
â”‚  â”‚  - Hip-Shoulder-Elbow angle                  â”‚â”‚                 â”‚
â”‚  â”‚  - Returns degrees (0-180)                   â”‚â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚                 â”‚
â”‚           â”‚                                       â”‚                 â”‚
â”‚           â–¼                                       â”‚                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚     Shoulder Exercise Logic (shoulderExercise.js)    â”‚          â”‚
â”‚  â”‚                                                       â”‚          â”‚
â”‚  â”‚  State Machine:                                      â”‚          â”‚
â”‚  â”‚  DOWN â†’ RAISING â†’ TARGET_REACHED â†’ LOWERING â†’       â”‚          â”‚
â”‚  â”‚  COMPLETED (count rep)                               â”‚          â”‚
â”‚  â”‚                                                       â”‚          â”‚
â”‚  â”‚  NEW: Angle Sequence Tracking                        â”‚          â”‚
â”‚  â”‚  currentRepAngleSequence.push([angle])              â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â”‚
â”‚           â”‚                                        â”‚                â”‚
â”‚           â”‚ On rep completion                      â”‚ Feedback       â”‚
â”‚           â–¼                                        â”‚                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                â”‚
â”‚  â”‚      LSTM Client (lstmClient.js)             â”‚ â”‚                â”‚
â”‚  â”‚  predictQuality(userId, angleSequence)       â”‚ â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ HTTP POST                              â”‚
            â”‚ /predict_quality                       â”‚
            â–¼                                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FLASK API SERVER                                  â”‚
â”‚                   (ml/api_server.py)                                â”‚
â”‚                   Port: 5000                                         â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              REQUEST HANDLER                                  â”‚  â”‚
â”‚  â”‚  @app.route('/predict_quality', methods=['POST'])            â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  1. Receive: {user_id, angles: [[a1], [a2], ...]}          â”‚  â”‚
â”‚  â”‚  2. Validate: Check shape and dimensions                     â”‚  â”‚
â”‚  â”‚  3. Compute rep_rom = max(|angles|)                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                                                         â”‚
â”‚           â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              PREPROCESSING                                    â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  1. Resample to SEQ_LEN (100 frames)                        â”‚  â”‚
â”‚  â”‚     - Linear interpolation                                   â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  2. Normalize (z-score)                                      â”‚  â”‚
â”‚  â”‚     angles_norm = (angles - mean) / std                      â”‚  â”‚
â”‚  â”‚     (mean, std from training)                                â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  3. Convert to tensor [1, 100, 18]                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                                                         â”‚
â”‚           â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           LSTM MODEL (models/lstm_quality.py)                â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚     Input: [batch=1, seq_len=100, features=18]              â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚  â”‚
â”‚  â”‚     â”‚  Bidirectional LSTM Layer 1         â”‚                 â”‚  â”‚
â”‚  â”‚     â”‚  - Hidden size: 64 per direction    â”‚                 â”‚  â”‚
â”‚  â”‚     â”‚  - Output: [1, 100, 128]            â”‚                 â”‚  â”‚
â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚  â”‚
â”‚  â”‚                     â–¼                                         â”‚  â”‚
â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚  â”‚
â”‚  â”‚     â”‚  Bidirectional LSTM Layer 2         â”‚                 â”‚  â”‚
â”‚  â”‚     â”‚  - Hidden size: 64 per direction    â”‚                 â”‚  â”‚
â”‚  â”‚     â”‚  - Final hidden: [1, 128]           â”‚                 â”‚  â”‚
â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚  â”‚
â”‚  â”‚                     â–¼                                         â”‚  â”‚
â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚  â”‚
â”‚  â”‚     â”‚  Fully Connected Layers             â”‚                 â”‚  â”‚
â”‚  â”‚     â”‚  - FC1: 128 â†’ 32 (ReLU)            â”‚                 â”‚  â”‚
â”‚  â”‚     â”‚  - Dropout (0.3)                    â”‚                 â”‚  â”‚
â”‚  â”‚     â”‚  - FC2: 32 â†’ 1                      â”‚                 â”‚  â”‚
â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚  â”‚
â”‚  â”‚                     â–¼                                         â”‚  â”‚
â”‚  â”‚              logit â†’ sigmoid                                 â”‚  â”‚
â”‚  â”‚                     â–¼                                         â”‚  â”‚
â”‚  â”‚     Output: quality_score âˆˆ [0, 1]                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                                                         â”‚
â”‚           â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚      PERSONALIZATION ENGINE (personalization.py)             â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  RehabPersonalizer.update_and_get_target(                   â”‚  â”‚
â”‚  â”‚      user_id, rep_rom, quality_score)                        â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  User Profile:                                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚  â”‚
â”‚  â”‚  â”‚ user_123:                                       â”‚         â”‚  â”‚
â”‚  â”‚  â”‚   baseline_rom: 85.0Â°  (first 5 reps avg)     â”‚         â”‚  â”‚
â”‚  â”‚  â”‚   best_rom: 112.0Â°     (max achieved)         â”‚         â”‚  â”‚
â”‚  â”‚  â”‚   ema_quality: 0.78    (smoothed score)       â”‚         â”‚  â”‚
â”‚  â”‚  â”‚   rep_count: 15                                â”‚         â”‚  â”‚
â”‚  â”‚  â”‚   target_rom: 118.0Â°   (next rep goal)        â”‚         â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  Target Adjustment Logic:                                    â”‚  â”‚
â”‚  â”‚  - quality > 0.8  â†’ target += 2Â°                            â”‚  â”‚
â”‚  â”‚  - quality 0.6-0.8 â†’ target += 1Â°                           â”‚  â”‚
â”‚  â”‚  - quality 0.4-0.6 â†’ target unchanged                        â”‚  â”‚
â”‚  â”‚  - quality < 0.4  â†’ target -= 2Â°                            â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  Constraints:                                                â”‚  â”‚
â”‚  â”‚  - target >= baseline_rom                                    â”‚  â”‚
â”‚  â”‚  - target <= best_rom + 30Â°                                 â”‚  â”‚
â”‚  â”‚  - target <= global_max_rom (145Â°)                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                                                         â”‚
â”‚           â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              RESPONSE                                         â”‚  â”‚
â”‚  â”‚  {                                                            â”‚  â”‚
â”‚  â”‚    "quality_score": 0.873,                                   â”‚  â”‚
â”‚  â”‚    "rep_rom": 112.34,                                        â”‚  â”‚
â”‚  â”‚    "personalized_target_angle": 118.0                        â”‚  â”‚
â”‚  â”‚  }                                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ HTTP Response (JSON)
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BROWSER (Feedback)                                â”‚
â”‚                                                                      â”‚
â”‚  lstmClient.js receives response                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  logPrediction(result)                                        â”‚  â”‚
â”‚  â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”                         â”‚  â”‚
â”‚  â”‚  ðŸ“Š LSTM Quality Prediction Results                           â”‚  â”‚
â”‚  â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”                         â”‚  â”‚
â”‚  â”‚  Quality Score: 87.3%                                         â”‚  â”‚
â”‚  â”‚  Rep ROM: 112.3Â°                                              â”‚  â”‚
â”‚  â”‚  Target ROM: 118.0Â°                                           â”‚  â”‚
â”‚  â”‚  Feedback: âœ… Great job! Form is looking good!                â”‚  â”‚
â”‚  â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                      â”‚
â”‚  shoulderExercise.js updates:                                       â”‚
â”‚  - personalizedTargetAngle = 118.0                                 â”‚
â”‚  - onFeedbackUpdate("âœ… Great job! Form is looking good!")         â”‚
â”‚  - sessionReps[last].lstm_quality_score = 0.873                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Training Pipeline (One-Time Setup)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     UI-PRMD DATASET                                  â”‚
â”‚                                                                      â”‚
â”‚  Segmented Movements/Kinect/Angles/                                â”‚
â”‚  â”œâ”€â”€ m07_s01_e01_angles.txt  (correct)                             â”‚
â”‚  â”œâ”€â”€ m07_s01_e02_angles.txt  (correct)                             â”‚
â”‚  â”œâ”€â”€ m07_s01_e03_angles_inc.txt  (incorrect) â† Note: _inc suffix  â”‚
â”‚  â”œâ”€â”€ m07_s02_e01_angles.txt  (correct)                             â”‚
â”‚  â””â”€â”€ ...                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               DATA LOADER (ui_prmd_loader.py)                        â”‚
â”‚                                                                      â”‚
â”‚  For each file:                                                     â”‚
â”‚  1. Parse filename â†’ extract movement, subject, episode, label     â”‚
â”‚  2. Load CSV â†’ shape [T_raw, J]                                    â”‚
â”‚  3. Select angle columns â†’ shape [T_raw, 18]                       â”‚
â”‚  4. Resample to 100 frames â†’ shape [100, 18]                       â”‚
â”‚  5. Label: 1 if correct, 0 if _inc                                 â”‚
â”‚                                                                      â”‚
â”‚  Output: ShoulderRehabDataset                                       â”‚
â”‚  - 40 reps (30 correct, 10 incorrect)                              â”‚
â”‚  - Normalized (z-score)                                             â”‚
â”‚  - Split: 80% train (32), 20% val (8)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  TRAINING LOOP (train_lstm.py)                       â”‚
â”‚                                                                      â”‚
â”‚  For epoch in 1..50:                                                â”‚
â”‚    For batch in train_loader:                                       â”‚
â”‚      1. Forward pass: logits = model(sequences)                    â”‚
â”‚      2. Compute loss: BCEWithLogitsLoss(logits, labels)            â”‚
â”‚      3. Backward pass: loss.backward()                              â”‚
â”‚      4. Update weights: optimizer.step()                            â”‚
â”‚                                                                      â”‚
â”‚    Validate on val_loader                                           â”‚
â”‚    If val_loss < best_val_loss:                                     â”‚
â”‚      Save checkpoint â†’ shoulder_lstm_model.pt                       â”‚
â”‚                                                                      â”‚
â”‚  Best checkpoint includes:                                          â”‚
â”‚  - model_state_dict                                                 â”‚
â”‚  - angle_mean, angle_std (for normalization)                        â”‚
â”‚  - global_max_rom (for personalization)                             â”‚
â”‚  - input_size, seq_len (for inference)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow Timeline (Single Rep)

```
t=0s    User in standing position
        â””â”€> State: DOWN
            â””â”€> Angle: 30Â°
            â””â”€> Action: None

t=0.5s  User starts raising arm
        â””â”€> State transition: DOWN â†’ RAISING
            â””â”€> Angle: 50Â°
            â””â”€> currentRepAngleSequence: [[30], [40], [50]]

t=1.0s  User continues raising
        â””â”€> State: RAISING
            â””â”€> Angle: 70Â°
            â””â”€> currentRepAngleSequence: [[30], ..., [70]]

t=1.5s  User reaches target
        â””â”€> State transition: RAISING â†’ TARGET_REACHED
            â””â”€> Angle: 95Â°
            â””â”€> currentRepAngleSequence: [[30], ..., [95]]

t=2.0s  User starts lowering arm
        â””â”€> State transition: TARGET_REACHED â†’ LOWERING
            â””â”€> Angle: 80Â°
            â””â”€> currentRepAngleSequence: [[30], ..., [95], [80]]

t=2.5s  User returns to start
        â””â”€> State transition: LOWERING â†’ COMPLETED
            â””â”€> Angle: 30Â°
            â””â”€> currentRepAngleSequence: [[30], ..., [95], ..., [30]]
            
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  REP COMPLETION TRIGGERS:           â”‚
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
            â”‚  1. repCount++ (update UI)         â”‚
            â”‚  2. Call predictQuality()          â”‚
            â”‚     â””â”€> Send POST to Flask API     â”‚
            â”‚  3. Wait for response (async)      â”‚
            â”‚  4. Update target angle            â”‚
            â”‚  5. Display feedback               â”‚
            â”‚  6. Reset angle sequence           â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

t=2.6s  LSTM prediction returns
        â””â”€> quality_score: 0.87
        â””â”€> rep_rom: 112.3Â°
        â””â”€> personalized_target_angle: 118.0Â°
        â””â”€> Feedback: "âœ… Great job! Form is looking good!"
        â””â”€> Console.log() shows formatted results

t=2.7s  User ready for next rep
        â””â”€> State: COMPLETED â†’ RAISING (when arm raises again)
        â””â”€> New target: 118.0Â° (updated from 90Â°)
        â””â”€> currentRepAngleSequence: [] (reset)
```

---

## File Dependencies Graph

```
START_PHASE7.ps1
    â”‚
    â””â”€> Activates venv & runs: python ml/api_server.py
            â”‚
            â”œâ”€> Loads: stable_baselines3 (for RL)
            â”œâ”€> Loads: models/dqn/DQN_rehab_final.zip
            â”‚
            â”œâ”€> Loads: models/lstm_quality.py
            â”‚       â””â”€> Imports: torch.nn
            â”‚
            â”œâ”€> Loads: models/shoulder_lstm_model.pt
            â”‚       â””â”€> Contains: model weights, normalization params
            â”‚
            â”œâ”€> Loads: personalization.py
            â”‚       â””â”€> Creates: RehabPersonalizer instance
            â”‚
            â””â”€> Starts Flask server on port 5000
                    â”‚
                    â”œâ”€> Endpoint: /predict (RL)
                    â”œâ”€> Endpoint: /predict_form (Form classifier)
                    â””â”€> Endpoint: /predict_quality (LSTM) â† NEW

demo/index.html
    â”‚
    â”œâ”€> Imports: utils/poseDetector.js (MediaPipe)
    â”œâ”€> Imports: utils/angles.js (Angle calculation)
    â”œâ”€> Imports: utils/lstmClient.js â† NEW
    â”‚       â””â”€> Function: predictQuality(userId, angles)
    â”‚
    â””â”€> Imports: exercises/shoulderExercise.js â† MODIFIED
            â”œâ”€> Uses: lstmClient.predictQuality()
            â””â”€> Tracks: currentRepAngleSequence
```

---

## Key Design Decisions

### 1. **Same Flask Server**
   - âœ… No separate LSTM server needed
   - âœ… PowerShell script unchanged
   - âœ… Single port, single process

### 2. **Asynchronous Predictions**
   - âœ… Non-blocking UI during API call
   - âœ… Rep counting continues immediately
   - âœ… Feedback shown when prediction returns

### 3. **Per-User Personalization**
   - âœ… Global `personalizer` instance in Flask
   - âœ… Maintains state across requests
   - âœ… Adapts to individual capability

### 4. **Graceful Fallback**
   - âœ… Works without LSTM (rule-based only)
   - âœ… Checks `lstmEnabled` before calling API
   - âœ… Returns default values on error

---

This diagram shows the complete end-to-end flow from user movement to LSTM prediction to adaptive feedback!
